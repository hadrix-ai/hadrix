import type { EvalGroupSpec } from "../../../types.js";

const NEXTJS_CASE = "cases/nextjs-baseline";
const NEXTJS_FAKEOUT_1_CASE = "cases/nextjs-fakeout-1";
const SUPABASE_CASE = "cases/supabase-baseline";
const BROKENCRYSTALS_CASE = "cases/brokencrystals-baseline";
const NODEGOAT_CASE = "cases/nodegoat-baseline";
const NODEVULNERABLE_CASE = "cases/nodevulnerable-baseline";

export const SECURITY_MISCONFIGURATION_GROUPS: EvalGroupSpec[] = [
  {
    id: "SECURITY-MISCONFIGURATION-Nextjs-Baseline",
    description:
      "Security misconfiguration baseline fixtures (Next.js) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_CASE}/lib/cors.ts`,
        expectation: "CORS configuration allows any origin",
        ruleId: "permissive_cors",
        severity: "medium",
        startLine: 6,
        endLine: 7,
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/debug/route.ts`,
        expectation: "Debug endpoint exposes request headers and environment secrets",
        ruleId: "debug_auth_leak",
        severity: "high",
        startLine: 12,
        endLine: 15,
      },
      {
        filepath: `${NEXTJS_CASE}/lib/supabase.ts`,
        expectation: "Service client falls back to an overprivileged anon key",
        ruleId: "anon_key_bearer",
        severity: "high",
        startLine: 12,
        endLine: 14,
      },
      {
        filepath: `${NEXTJS_CASE}/lib/storage.ts`,
        expectation: "Storage bucket configured for public access",
        ruleId: "public_storage_bucket",
        severity: "medium",
        startLine: 4,
        endLine: 5,
      },
    ],
  },
  {
    id: "SECURITY-MISCONFIGURATION-Nextjs-Fakeout1",
    description:
      "Security misconfiguration fakeout fixtures (Next.js) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/status/route.ts`,
        expectation: "Status endpoint CORS headers allow any origin with credentials enabled",
        ruleId: "permissive_cors",
        severity: "medium",
        startLine: 3,
        endLine: 5,
      },
    ],
  },
  {
    id: "SECURITY-MISCONFIGURATION-Supabase-Baseline",
    description:
      "Security misconfiguration baseline fixtures (React Supabase) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/_shared/cors.ts`,
        expectation: "Edge function CORS headers allow all origins",
        ruleId: "permissive_cors",
        severity: "medium",
        startLine: 6,
        endLine: 8,
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/get-project.ts`,
        expectation: "Debug endpoint enabled with verbose request and auth details",
        ruleId: "debug_auth_leak",
        severity: "high",
        startLine: 20,
        endLine: 27,
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/get-project.ts`,
        expectation: "Admin data access can use an overprivileged anon key",
        ruleId: "anon_key_bearer",
        severity: "high",
        startLine: 32,
        endLine: 34,
      },
      {
        filepath: `${SUPABASE_CASE}/frontend/utils/api.ts`,
        expectation: "Client requests use an overprivileged anon key as the bearer token",
        ruleId: "anon_key_bearer",
        severity: "high",
        startLine: 16,
        endLine: 18,
      },
    ],
  },
  {
    id: "SECURITY-MISCONFIG-BrokenCrystals",
    description: "Security misconfiguration fixtures (BrokenCrystals) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/middleware/cors.ts`,
        expectation: "CORS configuration allows any origin with credentials",
        ruleId: "permissive_cors",
        severity: "medium",
        startLine: 4,
        endLine: 5,
      },
    ],
  },
  {
    id: "SECURITY-MISCONFIG-NodeGoat",
    description: "Security misconfiguration fixtures (NodeGoat) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NODEGOAT_CASE}/server/routes/debug.ts`,
        expectation: "Debug endpoint exposes request headers and environment secrets",
        ruleId: "debug_auth_leak",
        severity: "high",
        startLine: 4,
        endLine: 10,
      },
    ],
  },
  {
    id: "SECURITY-MISCONFIG-NodeVulnerable",
    description: "Security misconfiguration fixtures (NodeVulnerable) in hadrix-evals-security-misconfiguration",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NODEVULNERABLE_CASE}/server/middleware/cors.ts`,
        expectation: "CORS configuration allows any origin with credentials",
        ruleId: "permissive_cors",
        severity: "medium",
        startLine: 4,
        endLine: 5,
      },
    ],
  },
];
