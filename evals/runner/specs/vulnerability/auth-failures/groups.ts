import type { EvalGroupSpec } from "../../../types.js";

const NEXTJS_CASE = "cases/nextjs-baseline";
const NEXTJS_FAKEOUT_1_CASE = "cases/nextjs-fakeout-1";
const SUPABASE_CASE = "cases/supabase-baseline";
const BROKENCRYSTALS_CASE = "cases/brokencrystals-baseline";

export const AUTH_FAILURES_GROUPS: EvalGroupSpec[] = [
  {
    id: "AUTH-FAILURES-Nextjs-Baseline",
    description: "Auth failures baseline fixtures (Next.js) in hadrix-evals-auth-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_CASE}/lib/auth.ts`,
        expectation: "JWT validation skipped or downgraded to header presence",
        ruleId: "jwt_validation_bypass",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_CASE}/app/login/page.tsx`,
        expectation: "Unlimited login attempts without lockout",
        ruleId: "missing_lockout",
        severity: "medium",
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/auth/login/route.ts`,
        expectation: "Login API lacks rate limiting",
        ruleId: "missing_rate_limiting",
        severity: "medium",
      },
    ],
  },
  {
    id: "AUTH-FAILURES-Nextjs-Fakeout1",
    description: "Auth failures fakeout fixtures (Next.js) in hadrix-evals-auth-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/auth/session/route.ts`,
        expectation: "JWT decoded without signature verification; unsigned session tokens accepted",
        ruleId: "jwt_validation_bypass",
        severity: "high",
      },
    ],
  },
  {
    id: "AUTH-FAILURES-Supabase-Baseline",
    description: "Auth failures baseline fixtures (React Supabase) in hadrix-evals-auth-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/_shared/auth.ts`,
        expectation: "JWT validation bypass: auth context created from presence of Authorization header",
        ruleId: "jwt_validation_bypass",
        severity: "critical",
      },
      {
        filepath: `${SUPABASE_CASE}/frontend/utils/api.ts`,
        expectation:
          "Trusting frontend session state; can send requests with empty or forged access tokens",
        ruleId: "missing_bearer_token",
        severity: "high",
      },
      {
        filepath: `${SUPABASE_CASE}/frontend/app/login/page.tsx`,
        expectation: "Unlimited login attempts: no lockout or rate limiting UX for password login",
        ruleId: "missing_lockout",
        severity: "medium",
      },
    ],
  },
  {
    id: "AUTH-FAILURES-BrokenCrystals",
    description: "Auth failures fixtures (BrokenCrystals) in hadrix-evals-auth-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/auth/jwt.ts`,
        expectation: "JWT decoded without signature verification; auth context built from untrusted claims",
        ruleId: "jwt_validation_bypass",
        severity: "high",
      },
    ],
  },
];
