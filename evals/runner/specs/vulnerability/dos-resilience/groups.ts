import type { EvalGroupSpec } from "../../../types.js";

const NEXTJS_CASE = "cases/nextjs-baseline";
const NEXTJS_FAKEOUT_1_CASE = "cases/nextjs-fakeout-1";
const SUPABASE_CASE = "cases/supabase-baseline";
const BROKENCRYSTALS_CASE = "cases/brokencrystals-baseline";

export const DOS_RESILIENCE_GROUPS: EvalGroupSpec[] = [
  {
    id: "DOS-RESILIENCE-Nextjs-Baseline",
    description: "DoS/resilience baseline fixtures (Next.js) in hadrix-evals-dos-resilience",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_CASE}/lib/http.ts`,
        expectation: "Outbound requests made without timeouts",
        ruleId: "missing_timeout",
        severity: "medium",
        startLine: 16,
        endLine: 16,
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/scan/route.ts`,
        expectation: "No timeout and retry storms around repo scan",
        ruleId: "missing_timeout",
        severity: "high",
        startLine: 12,
        endLine: 12,
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/projects/route.ts`,
        expectation: "Unbounded project list queries",
        ruleId: "unbounded_query",
        severity: "medium",
        startLine: 15,
        endLine: 15,
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/admin/users/route.ts`,
        expectation: "Unbounded admin user list queries",
        ruleId: "unbounded_query",
        severity: "medium",
        startLine: 22,
        endLine: 22,
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/upload/route.ts`,
        expectation: "Large payloads accepted without size limits",
        ruleId: "missing_upload_size_limit",
        severity: "medium",
        startLine: 6,
        endLine: 6,
      },
    ],
  },
  {
    id: "DOS-RESILIENCE-Nextjs-Fakeout1",
    description: "DoS/resilience fakeout fixtures (Next.js) in hadrix-evals-dos-resilience",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/lib/http.ts`,
        expectation:
          "AbortController timeout is created but never passed to fetch, leaving outbound calls without timeouts",
        ruleId: "missing_timeout",
        severity: "medium",
        startLine: 51,
        endLine: 51,
      },
    ],
  },
  {
    id: "DOS-RESILIENCE-Supabase-Baseline",
    description:
      "DoS/resilience baseline fixtures (React Supabase) in hadrix-evals-dos-resilience",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/scan-repo.ts`,
        expectation:
          "No timeouts on shell execution + retry storm behavior on failures when toggle enabled",
        ruleId: "missing_timeout",
        severity: "high",
        startLine: 7,
        endLine: 16,
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/list-projects.ts`,
        expectation: "Unbounded DB query risk when toggle enabled (no limit applied)",
        ruleId: "unbounded_query",
        severity: "medium",
        startLine: 31,
        endLine: 31,
      },
    ],
  },
  {
    id: "DOS-RESILIENCE-BrokenCrystals",
    description: "DoS/resilience fixtures (BrokenCrystals) in hadrix-evals-dos-resilience",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/routes/export.ts`,
        expectation: "Unbounded export query without limits or pagination",
        ruleId: "unbounded_query",
        severity: "medium",
        startLine: 11,
        endLine: 11,
      },
    ],
  },
];
