import type { EvalGroupSpec } from "../../../types.js";

const NEXTJS_CASE = "cases/nextjs-baseline";
const NEXTJS_FAKEOUT_1_CASE = "cases/nextjs-fakeout-1";
const SUPABASE_CASE = "cases/supabase-baseline";
const BROKENCRYSTALS_CASE = "cases/brokencrystals-baseline";
const NODEGOAT_CASE = "cases/nodegoat-baseline";

export const SOFTWARE_INTEGRITY_GROUPS: EvalGroupSpec[] = [
  {
    id: "SOFTWARE-INTEGRITY-Nextjs-Baseline",
    description:
      "Software/data integrity baseline fixtures (Next.js) in hadrix-evals-software-integrity",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_CASE}/app/api/webhook/route.ts`,
        expectation: "Unsigned webhooks accepted and signature verification can be skipped",
        ruleId: "missing_webhook_signature",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/webhook/route.ts`,
        expectation: "User-supplied transform logic executed with new Function",
        ruleId: "webhook_code_execution",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/webhook/route.ts`,
        expectation: "External config fetched without integrity checks",
        ruleId: "missing_webhook_config_integrity",
        severity: "medium",
      },
    ],
  },
  {
    id: "SOFTWARE-INTEGRITY-Nextjs-Fakeout1",
    description:
      "Software/data integrity fakeout fixtures (Next.js) in hadrix-evals-software-integrity",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/webhook/route.ts`,
        expectation: "Unsigned webhooks accepted when signature enforcement can be skipped",
        ruleId: "missing_webhook_signature",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/webhook/route.ts`,
        expectation: "User-supplied transform executed via Function constructor in webhook handler",
        ruleId: "webhook_code_execution",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/webhook/route.ts`,
        expectation: "External config fetched without integrity verification",
        ruleId: "missing_webhook_config_integrity",
        severity: "medium",
      },
    ],
  },
  {
    id: "SOFTWARE-INTEGRITY-Supabase-Baseline",
    description:
      "Software/data integrity baseline fixtures (React Supabase) in hadrix-evals-software-integrity",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/webhook.ts`,
        expectation: "Unsigned webhooks accepted when signature validation is disabled by toggle",
        ruleId: "missing_webhook_signature",
        severity: "high",
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/webhook.ts`,
        expectation:
          "User-supplied transform executed via new Function (code execution / integrity failure) when toggle enabled",
        ruleId: "webhook_code_execution",
        severity: "critical",
      },
    ],
  },
  {
    id: "SOFTWARE-INTEGRITY-BrokenCrystals",
    description: "Software/data integrity fixtures (BrokenCrystals) in hadrix-evals-software-integrity",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/routes/webhook.ts`,
        expectation: "Unsigned webhooks accepted without signature verification",
        ruleId: "missing_webhook_signature",
        severity: "high",
      },
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/routes/webhook.ts`,
        expectation: "User-supplied transform executed via Function constructor in webhook handler",
        ruleId: "webhook_code_execution",
        severity: "high",
      },
    ],
  },
  {
    id: "SOFTWARE-INTEGRITY-NodeGoat",
    description: "Software/data integrity fixtures (NodeGoat) in hadrix-evals-software-integrity",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NODEGOAT_CASE}/server/routes/deserialize.ts`,
        expectation:
          "User-supplied serialized profile is deserialized with node-serialize (insecure deserialization)",
        ruleId: "open_scan_logic_issues",
        severity: "high",
      },
    ],
  },
];
