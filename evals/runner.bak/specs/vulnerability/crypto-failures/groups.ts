import type { EvalGroupSpec } from "../../../types.js";

const NEXTJS_CASE = "cases/nextjs-baseline";
const NEXTJS_FAKEOUT_1_CASE = "cases/nextjs-fakeout-1";
const SUPABASE_CASE = "cases/supabase-baseline";
const BROKENCRYSTALS_CASE = "cases/brokencrystals-baseline";
const NODEGOAT_CASE = "cases/nodegoat-baseline";
const NODEVULNERABLE_CASE = "cases/nodevulnerable-baseline";

export const CRYPTO_FAILURES_GROUPS: EvalGroupSpec[] = [
  {
    id: "CRYPTO-FAILURES-Nextjs-Baseline",
    description:
      "Cryptographic failures baseline fixtures (Next.js) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_CASE}/lib/auth.ts`,
        expectation: "Weak/fallback JWT secret and decoding without verification",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_CASE}/app/api/tokens/route.ts`,
        expectation: "Insecure random token generation and plaintext token storage",
        severity: "high",
      },
      {
        filepath: `${NEXTJS_CASE}/app/actions/createApiToken.ts`,
        expectation: "Insecure random token generation in server action",
        severity: "medium",
      },
      {
        filepath: `${NEXTJS_CASE}/db/schema.sql`,
        expectation: "Plaintext token column in database schema",
        severity: "medium",
      },
    ],
  },
  {
    id: "CRYPTO-FAILURES-Nextjs-Fakeout1",
    description:
      "Cryptographic failures fakeout fixtures (Next.js) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NEXTJS_FAKEOUT_1_CASE}/app/api/password-reset/route.ts`,
        expectation:
          "Predictable password reset token derived from user data and stored in plaintext",
        severity: "high",
      },
    ],
  },
  {
    id: "CRYPTO-FAILURES-Supabase-Baseline",
    description:
      "Cryptographic failures baseline fixtures (React Supabase) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/create-api-token.ts`,
        expectation: "Insecure token generation using Math.random + timestamp",
        severity: "high",
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/functions/_shared/auth.ts`,
        expectation: "JWT decoded without signature verification using a weak fallback secret",
        severity: "high",
      },
      {
        filepath: `${SUPABASE_CASE}/backend/supabase/migrations/001_schema.sql`,
        expectation:
          "Plaintext secret storage: api_tokens.token_plaintext column stores tokens unencrypted/unsalted",
        severity: "high",
      },
    ],
  },
  {
    id: "CRYPTO-FAILURES-BrokenCrystals",
    description: "Cryptographic failures fixtures (BrokenCrystals) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/auth/tokens.ts`,
        expectation: "Weak JWT secret fallback used for signing session tokens",
        severity: "high",
      },
      {
        filepath: `${BROKENCRYSTALS_CASE}/server/auth/tokens.ts`,
        expectation: "Predictable API tokens generated with Math.random and stored in plaintext",
        severity: "high",
      },
    ],
  },
  {
    id: "CRYPTO-FAILURES-NodeGoat",
    description: "Cryptographic failures fixtures (NodeGoat) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NODEGOAT_CASE}/server/auth/jwt.ts`,
        expectation: "Weak JWT secret fallback used for signing session tokens",
        severity: "high",
      },
    ],
  },
  {
    id: "CRYPTO-FAILURES-NodeVulnerable",
    description: "Cryptographic failures fixtures (NodeVulnerable) in hadrix-evals-crypto-failures",
    allowUnexpected: true,
    expectedFindings: [
      {
        filepath: `${NODEVULNERABLE_CASE}/server/routes/password-reset.ts`,
        expectation: "Predictable password reset tokens generated with Math.random and timestamp",
        severity: "high",
      },
      {
        filepath: `${NODEVULNERABLE_CASE}/server/routes/password-reset.ts`,
        expectation: "Plaintext password reset tokens stored in database column token_plaintext",
        severity: "medium",
      },
    ],
  },
];
