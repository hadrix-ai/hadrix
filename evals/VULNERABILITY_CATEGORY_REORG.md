# Eval Repo + Spec Reorg by Vulnerability Category (Loop Plan)

## How to use this file (loop workflow)
- This file is the default PLAN_FILE for loop.sh.
- Checklist items must be actionable; the loop executes the first unchecked task.
- Keep each task small (1 to 3 files or one folder). Split work if it grows.
- After each step, mark the task complete and add follow-ups here.
- Keep the mapping table and expected findings in sync with new category repos.

## Context and goals
- Problem: app-based eval suites bundle multiple vulnerability classes, which makes
  category-specific regression and ownership harder.
- Goal: reorganize evals so each repo + spec pair targets one vulnerability class,
  while reusing the existing fixtures from Next.js and React Supabase suites.
- Guardrail: preserve behavior (no new vulns, no severity changes, no heuristic retuning).
- Coverage rule: specs must include all cases (baseline + fakeouts) so scanners must
  generalize and cannot pass by overfitting to a single fixture.

## Target layout
```
evals/
  hadrix-evals-sql-injection/
  hadrix-evals-idor/
  hadrix-evals-command-injection/
  hadrix-evals-xss/
  hadrix-evals-admin-authz/
  hadrix-evals-tenant-isolation/
  hadrix-evals-frontend-authz/
  hadrix-evals-rls-exposure/
  hadrix-evals-auth-failures/
  hadrix-evals-security-misconfiguration/
  hadrix-evals-crypto-failures/
  hadrix-evals-software-integrity/
  hadrix-evals-logging-monitoring/
  hadrix-evals-dos-resilience/
  hadrix-evals-vulnerable-deps/
  hadrix-evals-frontend-direct-db-write/

src/evals/specs/vulnerability/
  sql-injection/groups.ts
  idor/groups.ts
  command-injection/groups.ts
  ...
```
Each category repo stores all fixtures under `cases/<case-id>/`, including fakeouts.

## One-time setup decisions
- [x] Baseline repo dir name == spec id == GitHub repo name (for example `hadrix-evals-sql-injection`).
- [x] No separate specs for alternate cases: each category spec covers all cases (baseline + fakeouts)
      in the same repo under `evals/<repo>/cases/`.
- [x] Group ids encode category + source, and include case ids when needed
      (for example `SQLI-Nextjs-Baseline`, `SQLI-Nextjs-Fakeout1`).
- [x] Preserve relative file paths wherever possible to reduce spec churn.
- [x] Decide whether to fold `evals-sanity-check` into SQL injection or keep it standalone. (Decision: keep standalone for quick sanity checks.)
- [x] Decide when to deprecate app-based suites after category parity is reached. (Decision: keep app-based suites in `ALL_EVAL_SPECS` for two full releases after parity, and deprecate only after two consecutive category-only runs pass and `evals/README.md` is updated.)

### Category fixture index (keep updated)
| Category | Repo id | Cases path | Notes |
| --- | --- | --- | --- |
| SQL injection | hadrix-evals-sql-injection | evals/hadrix-evals-sql-injection/cases | Includes unsafe raw SQL + query builder injection. |
| IDOR | hadrix-evals-idor | evals/hadrix-evals-idor/cases | Uses ID-based fetch without ownership checks. |
| Command injection | hadrix-evals-command-injection | evals/hadrix-evals-command-injection/cases | Repo scan command concatenation. |
| XSS | hadrix-evals-xss | evals/hadrix-evals-xss/cases | Stored XSS via HTML rendering. |
| Admin authz | hadrix-evals-admin-authz | evals/hadrix-evals-admin-authz/cases | Admin role checks missing. |
| Tenant isolation | hadrix-evals-tenant-isolation | evals/hadrix-evals-tenant-isolation/cases | Client orgId trusted. |
| Frontend authz | hadrix-evals-frontend-authz | evals/hadrix-evals-frontend-authz/cases | Client-side-only enforcement. |
| RLS exposure | hadrix-evals-rls-exposure | evals/hadrix-evals-rls-exposure/cases | Supabase schema/policy exposure. |
| Auth failures | hadrix-evals-auth-failures | evals/hadrix-evals-auth-failures/cases | JWT validation + login rate limits. |
| Security misconfiguration | hadrix-evals-security-misconfiguration | evals/hadrix-evals-security-misconfiguration/cases | CORS, debug leaks, exposed keys. |
| Crypto failures | hadrix-evals-crypto-failures | evals/hadrix-evals-crypto-failures/cases | Weak secrets + plaintext tokens. |
| Software integrity | hadrix-evals-software-integrity | evals/hadrix-evals-software-integrity/cases | Webhook integrity checks. |
| Logging & monitoring | hadrix-evals-logging-monitoring | evals/hadrix-evals-logging-monitoring/cases | Audit logs + sensitive logging. |
| DoS/resilience | hadrix-evals-dos-resilience | evals/hadrix-evals-dos-resilience/cases | Missing timeouts and limits. |
| Vulnerable deps | hadrix-evals-vulnerable-deps | evals/hadrix-evals-vulnerable-deps/cases | OSV-detectable packages. |
| Frontend direct DB write | hadrix-evals-frontend-direct-db-write | evals/hadrix-evals-frontend-direct-db-write/cases | Client-side Supabase writes. |

## Per-category rules (apply to every item below)
- Each category repo contains only that vulnerability class.
- If a source file contains multiple vuln classes, clone it per category and remove
  unrelated vuln logic so the repo stays single-class.
- Preserve exploitability (no partial fixes or mitigations).
- Keep severities and `ruleId` values stable (OSV, RLS, static) for comparator hints.
- Update `expected_findings.json`, `enable.md`, and `hadrix.config.json` for each repo.
- Store additional cases under `evals/<repo>/cases/`, keeping the same relative file paths
  as baseline fixtures where possible.
- Use stable case ids that encode source + intent (for example `nextjs-baseline`,
  `supabase-baseline`, `nextjs-fakeout-1`).

## Category suites (worklist)

### SQL injection (hadrix-evals-sql-injection)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-sql-injection/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/sql-injection/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-sql-injection/cases/` and extend expected findings. (Added `nextjs-fakeout-1` raw SQL variant and query executor helper.)
- [x] Follow-up: include `nextjs-fakeout-1` expected findings in `src/evals/specs/vulnerability/sql-injection/groups.ts` so the eval spec covers the new case.

Source files:
- Next.js:
  - `app/api/projects/[id]/route.ts` (SQLi only; remove IDOR in this repo)
  - `lib/unsafeSql.ts`
  - `app/api/projects/route.ts` (unsafe `.or()` filter)
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/get-project.ts` (SQLi only)
  - `hadrix-react-supabase-app/backend/supabase/functions/list-projects.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/_shared/unsafeSql.ts` (if needed)
- Optional: fold `evals-sanity-check` into this repo as a minimal smoke subfolder.

### IDOR (hadrix-evals-idor)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-idor/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/idor/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-idor/cases/` and extend expected findings.
- [x] Follow-up: include the IDOR fakeout case in `src/evals/specs/vulnerability/idor/groups.ts` expected findings.

Source files:
- Next.js:
  - `app/api/projects/[id]/route.ts` (IDOR only; use safe query in this repo)
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/get-project.ts` (IDOR only)

### Command injection (hadrix-evals-command-injection)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-command-injection/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/command-injection/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-command-injection/cases/` and extend expected findings.

Source files:
- Next.js: `app/api/scan/route.ts`
- React Supabase: `hadrix-react-supabase-app/backend/supabase/functions/scan-repo.ts`

### XSS (hadrix-evals-xss)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-xss/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/xss/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-xss/cases/` and extend expected findings.
- [x] Follow-up: include XSS fakeout expected findings in `src/evals/specs/vulnerability/xss/groups.ts`.

Source files:
- Next.js:
  - `app/projects/[id]/page.tsx`
  - `db/seeds.sql` (stored payload source)
- React Supabase:
  - `hadrix-react-supabase-app/frontend/app/projects/[id]/page.tsx`
  - `hadrix-react-supabase-app/backend/supabase/migrations/003_seeds.sql`

### Admin authorization (hadrix-evals-admin-authz)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-admin-authz/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/admin-authz/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-admin-authz/cases/` and extend expected findings.

Source files:
- Next.js:
  - `app/api/admin/users/route.ts`
  - `app/api/admin/users/[id]/route.ts`
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/admin-delete-user.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/admin-list-users.ts` (if present)

### Tenant isolation (hadrix-evals-tenant-isolation)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-tenant-isolation/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/tenant-isolation/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-tenant-isolation/cases/` and extend expected findings.
- [x] Follow-up: include tenant-isolation fakeout expected findings in `src/evals/specs/vulnerability/tenant-isolation/groups.ts` so the eval spec covers the new case.

Source files:
- Next.js:
  - `app/api/projects/route.ts`
  - `app/actions/createProject.ts`
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/create-project.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/list-projects.ts`

### Frontend-only authz (hadrix-evals-frontend-authz)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-frontend-authz/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/frontend-authz/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-frontend-authz/cases/` and extend expected findings.

Source files:
- Next.js: `components/AdminUsers.tsx`
- React Supabase: `hadrix-react-supabase-app/frontend/admin/AdminUsers.tsx`

### RLS/datastore exposure (hadrix-evals-rls-exposure)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-rls-exposure/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/rls-exposure/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-rls-exposure/cases/` and extend expected findings.
- [x] Follow-up: include RLS fakeout expected findings in `src/evals/specs/vulnerability/rls-exposure/groups.ts`.

Source files:
- Next.js: `db/rls.sql`
- React Supabase: `hadrix-react-supabase-app/datastores/supabase/mock/schema.json`

### Auth failures (hadrix-evals-auth-failures)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-auth-failures/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/auth-failures/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-auth-failures/cases/` and extend expected findings.

Source files:
- Next.js:
  - `lib/auth.ts`
  - `app/login/page.tsx`
  - `app/api/auth/login/route.ts`
  - `app/api/admin/users/route.ts` (no MFA)
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/_shared/auth.ts`
  - `hadrix-react-supabase-app/frontend/utils/api.ts`
  - `hadrix-react-supabase-app/frontend/app/login/page.tsx`

### Security misconfiguration (hadrix-evals-security-misconfiguration)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-security-misconfiguration/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/security-misconfiguration/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-security-misconfiguration/cases/` and extend expected findings.
- [x] Follow-up: include security-misconfiguration fakeout expected findings in `src/evals/specs/vulnerability/security-misconfiguration/groups.ts`.

Source files:
- Next.js:
  - `lib/cors.ts`
  - `app/api/debug/route.ts`
  - `lib/supabase.ts`
  - `lib/storage.ts`
  - `lib/env.ts`
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/_shared/cors.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/get-project.ts` (debug leak)
  - `hadrix-react-supabase-app/frontend/utils/api.ts` (privileged key usage)

### Cryptographic failures (hadrix-evals-crypto-failures)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-crypto-failures/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/crypto-failures/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-crypto-failures/cases/` and extend expected findings. (Added `nextjs-fakeout-1` password reset token fixture.)

Source files:
- Next.js:
  - `lib/auth.ts` (weak JWT secret fallback)
  - `app/api/tokens/route.ts`
  - `app/actions/createApiToken.ts`
  - `db/schema.sql` (plaintext tokens)
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/create-api-token.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/_shared/auth.ts`
  - `hadrix-react-supabase-app/backend/supabase/migrations/001_schema.sql` (plaintext tokens)

### Software/data integrity (hadrix-evals-software-integrity)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-software-integrity/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/software-integrity/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id. (Added `hadrix-evals-software-integrity`.)
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-software-integrity/cases/` and extend expected findings. (Added `nextjs-fakeout-1` webhook variant.)
- [x] Follow-up: include software-integrity fakeout expected findings in `src/evals/specs/vulnerability/software-integrity/groups.ts`.

Source files:
- Next.js: `app/api/webhook/route.ts`
- React Supabase: `hadrix-react-supabase-app/backend/supabase/functions/webhook.ts`

### Logging & monitoring (hadrix-evals-logging-monitoring)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-logging-monitoring/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/logging-monitoring/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-logging-monitoring/cases/` and extend expected findings. (Added `nextjs-fakeout-1` token logging metadata case.)

Source files:
- Next.js:
  - `lib/audit.ts`
  - `app/api/projects/route.ts`
  - `app/api/tokens/route.ts`
  - `app/api/scan/route.ts`
  - `app/api/admin/users/[id]/route.ts`
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/admin-delete-user.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/create-api-token.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/scan-repo.ts`

### DoS/resilience (hadrix-evals-dos-resilience)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-dos-resilience/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/dos-resilience/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-dos-resilience/cases/` and extend expected findings. (Added `nextjs-fakeout-1` with ineffective AbortController timeout wiring.)

Source files:
- Next.js:
  - `lib/http.ts`
  - `app/api/scan/route.ts`
  - `app/api/projects/route.ts`
  - `app/api/admin/users/route.ts`
  - `app/api/upload/route.ts`
- React Supabase:
  - `hadrix-react-supabase-app/backend/supabase/functions/scan-repo.ts`
  - `hadrix-react-supabase-app/backend/supabase/functions/list-projects.ts`

### Vulnerable dependencies (hadrix-evals-vulnerable-deps)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-vulnerable-deps/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/vulnerable-deps/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-vulnerable-deps/cases/` and extend expected findings. (Added `nextjs-fakeout-1` variant package-lock case.)

Source files:
- Next.js: `package-lock.json`
- React Supabase: `hadrix-react-supabase-app/package-lock.json`

### Frontend direct DB writes (hadrix-evals-frontend-direct-db-write)
- [x] Baseline fixtures + metadata: create `evals/hadrix-evals-frontend-direct-db-write/cases/<case-id>/` using files below.
- [x] Spec wiring: add `src/evals/specs/vulnerability/frontend-direct-db-write/groups.ts`, export spec in
      `src/evals/specs/vulnerability/index.ts`, and register in `src/evals/specs.ts`.
- [x] Docs: update `evals/README.md` with the new spec id.
- [x] Additional cases: add fakeout/alt fixtures under `evals/hadrix-evals-frontend-direct-db-write/cases/` and extend expected findings.
- [x] Follow-up: include frontend-direct-db-write fakeout expected findings in `src/evals/specs/vulnerability/frontend-direct-db-write/groups.ts`.

Source files:
- Next.js: `components/ClientCreateProject.tsx`
- React Supabase: `hadrix-react-supabase-app/frontend/components/CreateProjectForm.tsx`

## Validation and bookkeeping
- [x] Update `evals/README.md` to list category specs as they land. (Grouped category specs vs app-based suites.)
- [x] Keep app-based suites in `ALL_EVAL_SPECS` until category parity is reached. (Verified in `src/evals/specs.ts`.)
- [x] Run category suites after each phase and record results in `evals/README.md`. (Attempted 2026-02-02; blocked by missing OpenAI API key for eval comparator.)
- [ ] Re-run category suites once `HADRIX_LLM_API_KEY` or `OPENAI_API_KEY` is configured, then update the run log in `evals/README.md` with full results.
